<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload Vid√©o - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .video-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .video-item {
            position: relative;
            width: 200px;
        }
        .video-item video {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>üé• Test Upload Vid√©o - Diagnostic Complet</h1>
    
    <div class="test-section">
        <h2>üìÅ √âtape 1: S√©lectionner une vid√©o</h2>
        <input type="file" id="videoInput" accept="video/*" multiple>
        <p><em>S√©lectionnez un fichier vid√©o (MP4, WebM, MOV) pour tester l'upload.</em></p>
    </div>
    
    <div class="test-section">
        <h2>üëÄ √âtape 2: Pr√©visualisation</h2>
        <div id="videoPreview" class="video-preview"></div>
        <p id="previewStatus">Aucune vid√©o s√©lectionn√©e</p>
    </div>
    
    <div class="test-section">
        <h2>üîß √âtape 3: Tests des fonctions</h2>
        <button onclick="testGetUploadedVideos()">Tester getUploadedVideos()</button>
        <button onclick="simulateFormSubmit()">Simuler soumission formulaire</button>
        <button onclick="checkLocalStorage()">V√©rifier localStorage</button>
        <button onclick="clearAll()">Tout effacer</button>
    </div>
    
    <div class="test-section">
        <h2>üìã Journal de debug</h2>
        <div id="debugLog" class="log">Pr√™t pour les tests...\n</div>
    </div>

    <script>
        let debugLog = document.getElementById('debugLog');
        let videoCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            console.log(`[${timestamp}] ${message}`);
            debugLog.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // Fonction exacte du dashboard.js
        function addVideoToPreview(videoSrc, id) {
            const previewContainer = document.getElementById('videoPreview');
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.innerHTML = `
                <video controls muted src="${videoSrc}">
                    Votre navigateur ne supporte pas la vid√©o.
                </video>
                <button type="button" onclick="removeVideo(this)" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 25px; height: 25px;">√ó</button>
            `;
            previewContainer.appendChild(videoItem);
            videoCount++;
            
            // V√©rification que le src est bien d√©fini
            const videoElement = videoItem.querySelector('video');
            log(`üîß Attribut src d√©fini: ${videoElement.src ? 'OUI' : 'NON'} (${videoElement.src ? videoElement.src.length : 0} caract√®res)`, videoElement.src ? 'success' : 'error');
            
            document.getElementById('previewStatus').textContent = `${videoCount} vid√©o(s) en pr√©visualisation`;
            log(`‚úÖ Vid√©o ajout√©e √† la pr√©visualisation (ID: ${id})`, 'success');
            log(`üìè Taille des donn√©es: ${(videoSrc.length / 1024).toFixed(2)} KB`, 'info');
        }
        
        function removeVideo(button) {
            button.parentElement.remove();
            videoCount--;
            document.getElementById('previewStatus').textContent = `${videoCount} vid√©o(s) en pr√©visualisation`;
            log('üóëÔ∏è Vid√©o supprim√©e de la pr√©visualisation', 'warning');
        }
        
        // Fonction exacte du dashboard.js avec debugging am√©lior√©
        function getUploadedVideos() {
            const videos = [];
            const previewContainer = document.getElementById('videoPreview');
            
            if (!previewContainer) {
                log('‚ùå ERREUR: Conteneur videoPreview introuvable!', 'error');
                return videos;
            }
            
            const videoElements = previewContainer.querySelectorAll('video');
            log(`üîç Recherche de vid√©os dans le conteneur...`, 'info');
            log(`üìä ${videoElements.length} √©l√©ments vid√©o trouv√©s`, 'info');
            
            videoElements.forEach((video, index) => {
                log(`üé¨ Vid√©o ${index + 1}:`, 'info');
                log(`   - src pr√©sent: ${video.src ? '‚úÖ OUI' : '‚ùå NON'}`, video.src ? 'success' : 'error');
                log(`   - longueur src: ${video.src ? video.src.length : 0} caract√®res`, 'info');
                log(`   - type de donn√©es: ${video.src ? (video.src.startsWith('data:') ? 'base64' : 'URL') : 'aucun'}`, 'info');
                
                if (video.src && video.src.startsWith('data:')) {
                    videos.push(video.src);
                    log(`   ‚úÖ Vid√©o ${index + 1} ajout√©e √† la collection`, 'success');
                } else {
                    log(`   ‚ö†Ô∏è Vid√©o ${index + 1} ignor√©e (src invalide ou manquant)`, 'warning');
                }
            });
            
            log(`üì¶ Total des vid√©os collect√©es: ${videos.length}`, videos.length > 0 ? 'success' : 'warning');
            return videos;
        }
        
        function handleVideoFiles(files) {
            log(`üì• Traitement de ${files.length} fichier(s)...`, 'info');
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('video/')) {
                    if (file.size > 50 * 1024 * 1024) {
                        log(`‚ùå Fichier trop volumineux: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'error');
                        return;
                    }
                    
                    log(`üìñ Lecture du fichier: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const id = 'video_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        log(`üéØ Fichier lu avec succ√®s, cr√©ation de la pr√©visualisation...`, 'success');
                        addVideoToPreview(e.target.result, id);
                    };
                    
                    reader.onerror = function() {
                        log(`‚ùå Erreur lors de la lecture du fichier: ${file.name}`, 'error');
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    log(`‚ùå Type de fichier non support√©: ${file.type}`, 'error');
                }
            });
        }
        
        function testGetUploadedVideos() {
            log('üß™ === TEST DE getUploadedVideos() ===', 'info');
            const videos = getUploadedVideos();
            
            if (videos.length === 0) {
                log('‚ö†Ô∏è Aucune vid√©o trouv√©e! V√©rifiez que des vid√©os sont bien upload√©es.', 'warning');
            } else {
                log(`‚úÖ Test r√©ussi! ${videos.length} vid√©o(s) r√©cup√©r√©e(s)`, 'success');
                videos.forEach((video, index) => {
                    log(`   Vid√©o ${index + 1}: ${video.substring(0, 50)}... (${video.length} caract√®res)`, 'info');
                });
            }
        }
        
        function simulateFormSubmit() {
            log('üß™ === SIMULATION SOUMISSION FORMULAIRE ===', 'info');
            
            const uploadedVideos = getUploadedVideos();
            
            const testProperty = {
                id: 'test_' + Date.now(),
                title: 'Propri√©t√© de test',
                location: 'Test Location',
                price: 100000,
                videos: uploadedVideos,
                images: [],
                createdAt: new Date().toISOString()
            };
            
            log(`üìã Propri√©t√© cr√©√©e:`, 'info');
            log(`   - ID: ${testProperty.id}`, 'info');
            log(`   - Titre: ${testProperty.title}`, 'info');
            log(`   - Vid√©os: ${testProperty.videos.length}`, testProperty.videos.length > 0 ? 'success' : 'warning');
            
            // Simulation sauvegarde localStorage
            let properties = JSON.parse(localStorage.getItem('properties')) || [];
            properties.push(testProperty);
            localStorage.setItem('properties', JSON.stringify(properties));
            
            log(`üíæ Propri√©t√© sauvegard√©e dans localStorage`, 'success');
            
            // V√©rification
            const savedProperties = JSON.parse(localStorage.getItem('properties')) || [];
            const savedProperty = savedProperties.find(p => p.id === testProperty.id);
            
            if (savedProperty && savedProperty.videos.length === uploadedVideos.length) {
                log(`‚úÖ V√âRIFICATION R√âUSSIE: Propri√©t√© sauvegard√©e avec ${savedProperty.videos.length} vid√©o(s)`, 'success');
            } else {
                log(`‚ùå √âCHEC DE V√âRIFICATION: Probl√®me lors de la sauvegarde`, 'error');
            }
        }
        
        function checkLocalStorage() {
            log('üß™ === V√âRIFICATION LOCALSTORAGE ===', 'info');
            
            const properties = JSON.parse(localStorage.getItem('properties')) || [];
            log(`üìä ${properties.length} propri√©t√©(s) trouv√©e(s) dans localStorage`, 'info');
            
            properties.forEach((property, index) => {
                log(`üè† Propri√©t√© ${index + 1}: ${property.title}`, 'info');
                log(`   - Images: ${property.images ? property.images.length : 0}`, 'info');
                log(`   - Vid√©os: ${property.videos ? property.videos.length : 0}`, property.videos && property.videos.length > 0 ? 'success' : 'warning');
                
                if (property.videos && property.videos.length > 0) {
                    property.videos.forEach((video, vIndex) => {
                        log(`     Vid√©o ${vIndex + 1}: ${video.length} caract√®res`, 'info');
                    });
                }
            });
        }
        
        function clearAll() {
            document.getElementById('videoPreview').innerHTML = '';
            videoCount = 0;
            document.getElementById('previewStatus').textContent = 'Aucune vid√©o s√©lectionn√©e';
            localStorage.removeItem('properties');
            debugLog.innerHTML = 'Tout effac√©. Pr√™t pour de nouveaux tests...\n';
            log('üßπ Tout a √©t√© effac√©', 'info');
        }
        
        // Configuration de l'input fichier
        document.getElementById('videoInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                log(`üìÅ ${e.target.files.length} fichier(s) s√©lectionn√©(s)`, 'info');
                handleVideoFiles(e.target.files);
            }
        });
        
        log('üöÄ Page de test charg√©e avec succ√®s!', 'success');
        log('üëÜ S√©lectionnez une vid√©o pour commencer les tests...', 'info');
    </script>
</body>
</html>
